<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Type Ahead ðŸ‘€</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="https://fav.farm/ðŸ”¥" />
  </head>

  <body>
    <form class="search-form">
      <input type="text" class="search" placeholder="City or State" />
      <ul class="suggestions"></ul>
    </form>

    <script>
      /*
        ç›®æ¨™: åœ¨æœå°‹æ¡†è¼¸å…¥æ–‡å­—ï¼ŒæŸ¥è©¢åŸŽå¸‚æˆ–å·žçš„äººå£
        1. å–å¾—æœå°‹æ¡†æ–‡å­— (è¨»å†Šç›£è½å™¨)
        2. ç¯©é¸åŸŽå¸‚æ¸…å–® (å–å¾—é—œéµå­—->è™•ç†å­—ä¸²->ç¯©é¸æ¸…å–®)
        3. æ¸²æŸ“åœ¨ç•«é¢ä¸Š (DOMæ“ä½œ)
        4. å¯¦æ™‚æœå°‹ (é‚Šè¼¸å…¥æ–‡å­—é‚Šè·³å‡ºå»ºè­°)
        5. ç¬¦åˆçš„é—œéµå­—highlightå¥—è‰² (æ‰¾åˆ°é—œéµå­—->åŠ ä¸Šclassåç¨±)
      */

      // å–å¾—è³‡æ–™

      const url =
        'https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json';

      const cities = [];
      let currentCityList = cities;

      fetch(url)
        .then((response) => {
          return response.json(); // è½‰æˆJSONæ ¼å¼
        })
        .then((jsonData) => {
          return cities.push(...jsonData);
        })
        .catch((error) => {
          return console.log(error);
        });

      // ç¯©é¸æ¸…å–®ã€æ¸²æŸ“æ¸…å–®

      function filterCityList(keyword) {
        currentCityList = cities.filter((city) => {
          const cityInfo = `${city.city} ${city.state}`.toLowerCase();
          return cityInfo.includes(keyword);
        });
      }

      function createCityInfoHTML(keyword, city) {
        const cityInfoStr = `${city.city}, ${city.state}`;
        const cityInfoChars = [];
        let startIndex = 0;
        let targetIndex = 0;

        while (cityInfoStr.toLowerCase().includes(keyword, startIndex)) {
          targetIndex = cityInfoStr.toLowerCase().indexOf(keyword, startIndex);
          cityInfoChars.push(
            ...cityInfoStr.slice(startIndex, targetIndex),
            '<span class="highlight">',
            ...cityInfoStr.slice(targetIndex, targetIndex + keyword.length),
            '</span>'
          );
          startIndex = targetIndex + keyword.length;
        }

        cityInfoChars.push(...cityInfoStr.slice(startIndex));
        return cityInfoChars.join('');
      }

      function createCityPopuHTML(city) {
        const cityPopuStr = city.population;
        const cityPopuChars = [];
        let count = 0;

        for (let i = cityPopuStr.length - 1; i >= 0; i--) {
          cityPopuChars.unshift(cityPopuStr[i]);
          count++;
          if (count % 3 === 0 && i !== 0) cityPopuChars.unshift(',');
        }

        return cityPopuChars.join('');
      }

      function displaySuggestions(keyword) {
        let HTML = '';

        currentCityList.forEach((city) => {
          const cityInfoHTML = createCityInfoHTML(keyword, city);
          const cityPopuHTML = createCityPopuHTML(city);
          HTML += `
            <li>
              <div class="info">${cityInfoHTML}</div>
              <div class="population">${cityPopuHTML}</div>
            </li>
          `;
        });

        suggestionList.innerHTML = HTML;
      }

      const suggestionList = document.querySelector('.suggestions');
      const searchInput = document.querySelector('.search');
      searchInput.addEventListener('input', (e) => {
        const keyword = e.target.value?.trim().toLowerCase();
        filterCityList(keyword);
        displaySuggestions(keyword);
      });
    </script>
  </body>
</html>
